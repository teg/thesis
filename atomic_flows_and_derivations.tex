\section{Atomic Flows and Derivations}\label{section:FlowsAndDerivations}

\subsection{Extracting Flows from Derivations}\label{subsection:ExtractingFlowsFromDerivations}

We now define the mapping from derivations to atomic flows. As we said, the idea is that structural rule instances map to the respective atomic-flow vertices, and the edges trace the atom occurrences between rule instances. We first state a fact, whose proof is immediate.

%------------------------------------------------
\begin{proposition}\label{proposition:FlowUnique}
Given an\/ $\SKS$ derivation\/ $\Phi$, there is a unique atomic flow $\phi$ such that:
\begin{enumerate}
%
\item there is a surjective map between the set of atom occurrences of\/ $\Phi$ and the set of edges of $\phi$;
%
\item there is a bijective map between the set of structural inference rule instances of\/ $\Phi$ and the set of vertices of $\phi$, such that, for each inference rule instance $\rho$ that maps to a vertex $\nu$, the label of $\nu$ are given below, for each possible case of the inference rules:
\[
\begin{array}{@{}ccc@{}ccc@{}}
\vlinf{\aid}{}{\vls[a^\one.{\bar a^\two}]}{\ttt}&\mbox{to\/}&
\vcenter{\afaid\one{}{}\two{}{}}
\quad,&\qquad
\vlinf{\aiu}{}{\fff}{\vls(a^\one.{\bar a^\two})}&\mbox{to\/}&
\vcenter{\afaiu\one{}{}\two{}{}}
\quad,\\
\noalign{\medskip}
\vlinf{\awd}{}{a^\one}{\fff}                    &\mbox{to\/}&
\vcenter{\afawd{}{}{}\one{}} 
\quad,&\qquad
\vlinf{\awu}{}{\ttt}{a^\one}                    &\mbox{to\/}&
\vcenter{\afawu{}{}{}\one{}}
\quad,\\
\noalign{\medskip}
\vlinf{\acd}{}{a^\three}{\vls[a^\one.a^\two]}   &\mbox{to\/}&
\vcenter{\afacd\one{}{}\two{}\three}
\quad,&\qquad
\vlinf{\acu}{}{\vls(a^\two.a^\three)}{a^\one}   &\mbox{to\/}&
\vcenter{\afacu\two{}{}\three{}\one}
\quad,\\
\end{array}
\]
and the map between the atom occurrences in the premiss (resp., conclusion) of $\rho$ and the upper (resp., lower) edges of $\nu$ is indicated by small numerals; and
%
\item for each inference rule instance of\/ $\Phi$ of kind
\[\hss
\begin{array}{@{}r@{}l@{}}
\vlinf{\swi}{}{\vls[(\alpha.\beta).\gamma]}
              {\vls(\alpha.[\beta.\gamma])}           \quad,&\qquad
\vlinf{\med}{}{\vls([\alpha.\gamma].[\beta.\delta])}
              {\vls[(\alpha.\beta).(\gamma.\delta)]}  \quad,      \\
\noalign{\smallskip}
\vlinf{\coor}{}{\vls[\beta.\alpha]}{\vls[\alpha.\beta]}\quad,\qquad
\vlinf{\coand}{}{\vls(\beta.\alpha)}{\vls(\alpha.\beta)}\quad,&\qquad
\vlinf{\asor}{}{\vls[[\alpha.\beta].\gamma]}
         {\vls[\alpha.[\beta.\gamma]]}                \quad,\qquad
\vlinf{\asand}{}{\vls(\alpha.(\beta.\gamma))}
         {\vls((\alpha.\beta).\gamma)}                \quad,      \\
\noalign{\smallskip}
\vlinf{\fffd}{}{\vls[\alpha.\fff]}{\alpha}           \quad,\qquad
\vlinf{\tttd}{}{\vls(\alpha.\ttt)}{\alpha}           \quad,&\qquad
\vlinf{\fffu}{}{\alpha}{\vls(\ttt.\alpha)}        \qquad\hbox{and\/}\qquad
\vlinf{\tttu}{}{\alpha}{\vls[\fff.\alpha]}
\end{array}
\]
all the atom occurrences in $\alpha$, $\beta$, $\gamma$ and $\delta$ in the premiss are respectively mapped to the same edges of $\phi$ as the atom occurrences in $\alpha$, $\beta$, $\gamma$ and $\delta$ in the conclusion.
\end{enumerate}
\end{proposition}

%---------------------------------------
\begin{definition}\label{definition:AssociatedFlow}
Given a derivation $\Phi$, we say that the unique atomic flow $\phi$ defined in Proposition~\vref{proposition:FlowUnique} is the atomic flow \emph{associated with}\index{flow!associated with derivation} the derivation $\Phi$. Sometimes, when an atom occurrence $a$ in $\Phi$ is mapped to an edge $\epsilon$ in $\phi$, we decorate $a$ with the label $\epsilon$ or the label $\phi$.
\end{definition}
%---------------

%--------------
\begin{example}
Figure~\vref{figure:ExampleAtomicFlows} has three examples of derivations and their associated atomic flows, where colors are used to indicate the mapping from atom occurrences to edges.
\end{example}
%------------

\newcommand{\RD}[1]{{\color{Red}#1}}
\newcommand{\GR}[1]{{\color{Green}#1}}
\newcommand{\DO}[1]{{\color{DarkOrchid}#1}}
\newcommand{\PR}[1]{{\color{ProcessBlue}#1}}
\newcommand{\MG}[1]{{\color{Magenta}#1}}
\newcommand{\SG}[1]{{\color{SpringGreen}#1}}
\newcommand{\RS}[1]{{\color{RawSienna}#1}}
\newcommand{\YO}[1]{{\color{YellowOrange}#1}}
\newcommand{\PW}[1]{{\color{Periwinkle}#1}}
%-------------------------------------------------------------------------------
\begin{figure}
\[
%---------------------------------------
\begin{array}{@{}c@{}c@{}c@{}}
\vlderivation                                                {
\vlin=   {}{\ttt                                  }         {
\vlin\aiu{}{\vls[\fff.\ttt]                       }        {
\vlin=   {}{\vls[(\GR{a}.\RD{\bar a}).\ttt]       }       {
\vlin\swi{}{\vls[[(\RD{\bar a}.\GR{a}).\ttt].\ttt]}      {
\vlin=   {}{\vls[(\RD{\bar a}.[\GR{a}.\ttt]).\ttt]}     {
\vlin\swi{}{\vls[([\GR{a}.\ttt].\RD{\bar a}).\ttt]}    {
\vlin=   {}{\vls([\GR{a}.\ttt].[\RD{\bar a}.\ttt])}   {
\vlin\med{}{\vls([\GR{a}.\ttt].[\ttt.\RD{\bar a}])}  {
\vlin=   {}{\vls[(\GR{a}.\ttt).(\ttt.\RD{\bar a})]} {
\vlin\aid{}{\vls[\GR{a}.\RD{\bar a}]              }{
\vlhy      {\ttt                                  }}}}}}}}}}}}
\qquad&
%-------------------
\vlderivation                                                              {
\vlin\aiu{}
   {\vls(\DO{a}.\fff)                                            }        {
\vlin=   {}
   {\vls(\DO{a}.(\PR{a}.\MG{\bar a}))                            }       {
\vlin\acu{}
   {\vls((\DO{a}.\PR{a}).\MG{\bar a})                            }      {
\vlin=   {}
   {\vls(\SG{a}.\MG{\bar a})                                     }     {
\vlin\aiu{}
   {\vls([\fff.\SG{a}].\MG{\bar a})                              }    {
\vlin\acd{}
   {\vls([(\RD{a}.\RS{\bar a}).\SG{a}].\MG{\bar a})              }   {
\vlin\swi{}
   {\vls([(\RD{a}.[\GR{\bar a}.\YO{\bar a}]).\SG{a}].\MG{\bar a})}  {
\vlin=   {}
   {\vls((\RD{a}.[[\GR{\bar a}.\YO{\bar a}].\SG{a}]).\MG{\bar a})} {
\vlin\aid{}
   {\vls((\RD{a}.[\GR{\bar a}.[\YO{\bar a}.\SG{a}]]).\MG{\bar a})}{
\vlhy        
   {\vls((\RD{a}.[\GR{\bar a}.\ttt]).\MG{\bar a})                }}}}}}}}}}}
\qquad&
%-------------------
\vlderivation                                                            {
\vlin=   {}{\vls(([\RS{a}.\YO{b}].\PW{a}).([\GR{a}.\DO{b}].\SG{a}))}    {
\vlin\med{}{\vls(([\RS{a}.\YO{b}].[\GR{a}.\DO{b}]).(\PW{a}.\SG{a}))}   {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].(\PW{a}.\SG{a}))}  {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].\MG{a})         } {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).\PR{b}].\MG{a})                  }{
\vlhy      {\vls([\RD{a}.\PR{b}].\MG{a})                           }}}}}}}
\\
\noalign{\bigskip}
%---------------------------------------
\vlderivation                                                      {
\vlin\swi{}{\vlsbr[\vlinf{\swi}
                         {}
                         {\vls[\vlinf{}
                                     {}
                                     {\fff}
                                     {\vls(\GR{a}.\RD{\bar a})}
                              \;.\;
                              \ttt]}
                         {\vls([\GR{a}.\ttt].\RD{\bar a})}
                  \;\;.\;\;
                   \ttt
                  ]                                            }  {
\vlin\med{}{\vls([\GR{a}.\ttt].[\ttt.\RD{\bar a}])             } {
\vlin{}  {}{\vls[\GR{a}.\RD{\bar a}]                           }{
\vlhy      {\ttt                                               }}}}}
\qquad&
%-------------------
\vlinf=
      {}
      {\vls(\DO{a}\;.\;\vlinf{}{}\fff{\vls(\PR{a}.\MG{\bar a})})}      
      {\vlsbr(\vlinf\swi
                    {}
                    {\vls[\vlinf{}
                                {}
                                \fff
                                {\vls(\RD{a}
                                     \;.\;\vlinf{}
                                            {}
                                            {\RS{\bar a}}
                                            {\vls[\GR{\bar a}.\YO{\bar a}]}
                                     )}
                         \;\;.\;\;
                         \vlinf{}{}{\vls(\DO{a}.\PR{a})}{\SG{a}}
                         ]}
                    {\vls(\RD{a}
                         \;.\;[\GR{\bar a}
                          \;.\;\vlinf{}
                                 {}
                                 {\vls[\YO{\bar a}.\SG{a}]}
                                 \ttt
                          ]
                         )}
            \;\;\;\;.\;\;\;\;
            \MG{\bar a}
            )}
\qquad&
%-------------------
\vls(\vlinf\med
           {}
           {\vls([\RS{a}.\YO{b}].[\GR{a}.\DO{b}])}
           {\vls[\vlinf{}{}{\vls(\RS{a}.\GR{a})}{\RD{a}}
                \;.\;{\vlinf{}{}{\vls(\YO{b}.\DO{b})}{\PR{b}}}
                ]}
    \;\;.\;\;
     \vlinf{}{}{\vls(\PW{a}.\SG{a})}{\MG{a}}
    )
\\
\noalign{\bigskip}
%---------------------------------------
\atomicflow{
(0,0)*{\afaiucol{}{}{}{}{}{}{Green}{Red}{}};
(0,4)*{\afaidnw{}{}}}
\qquad&
%-------------------
\atomicflow{
( 2,14)*{\afvjcol4{Green}};
( 0,10)*{\afvjcol{12}{Red}};
(16,10)*{\afvjcol{12}{Magenta}};
( 4, 8)*{\afacdcol{}{}{}{}{}{}{Green}{YellowOrange}{RawSienna}};
(10, 8)*{\afacucol{}{}{}{}{}{}{DarkOrchid}{ProcessBlue}{SpringGreen}};
( 2, 2)*{\afaiunw{}{}};
( 8, 2)*{\afvjcol4{DarkOrchid}};
(14, 2)*{\afaiunw{}{}};
( 8,12)*{\afaidnw{}{}}}
\qquad&
%-------------------
\atomicflow{
( 0,0)*{\afacucol{}{}{}{}{}{}{RawSienna}{Green}{Red}};
( 6,0)*{\afacucol{}{}{}{}{}{}{YellowOrange}{DarkOrchid}{ProcessBlue}};
(12,0)*{\afacucol{}{}{}{}{}{}{Periwinkle}{SpringGreen}{Magenta}}}
\end{array}
\]
\caption{Examples of derivations in the calculus of structures (top row), their translation into the functorial calculus (middle row), and the atomic flows associated with the latter (bottom row).}
\label{figure:ExampleAtomicFlows}
\end{figure}

%--------------------------------------------------
\begin{definition}\label{definiton:FlowRestriction}
Given a derivation $\Phi$ with atomic flow $\phi$, and an atom $a$, the \emph{restriction of $\phi$ to $a$}\index{flow!restriction to atom} is the largest subflow $\phi_a$ of $\phi$, such that every edge of $\phi_a$ is mapped to from $a$ or $\bar a$.
\end{definition}
%---------------

%--------------
\begin{example}
Consider the rightmost derivation and its associated atomic flow in Figure~\ref{figure:ExampleAtomicFlows}. The restriction of this flow to $a$ is:
\[
\atomicflow{
(-3,0)*{\afacucol{}{}{}{}{}{}{RawSienna}{Green}{Red}};
( 3,0)*{\afacucol{}{}{}{}{}{}{Periwinkle}{SpringGreen}{Magenta}}
}
\]
\end{example}
%------------

%=================================================================
\subsection{A Normal Form of Derivation}\label{subsection:DerNormalForm}

In this section we introduce the \emph{$\ai$-decomposed form} of a derivation. The reason for introducing this normal form is that we will often find it convenient to assume that identity instances appear at the top and cut instances appear at the bottom of a derivation. The important features of this normal form is that a derivation can be transformed into $\ai$-decomposed form without changing its atomic flow, and without significantly changing its size.

\begin{definition}\label{definition:aiDecomposedForm}
Given two derivations
\[
\vlder{\Phi}{}{\beta}{\alpha}
\quad\mbox{and}\quad
\Psi\;=\;
\vlder{}{\SKS\setminus\{\aid,\aiu\}}
{
 \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(b_m.\bar b_m)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(b_1.\bar b_1)}]
}
{
 \vlsbr(\vlinf{}{}{\vls[a_1.\bar a_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[a_n.\bar a_n]}{\ttt}\;.\;\alpha)
}\quad,
\]
for some atoms $a_1,\dots,a_n,b_1,\dots,b_m$, such that $\Phi$ and $\Psi$ have the same atomic flow, we say that $\Psi$ is an \emph{$\ai$-decomposed form of\/ $\Phi$}\index{$\ai$-decomposed form}.
\end{definition}

\begin{convention}\label{convention:AlternativeAiDecomposedForm}
Given a derivation $\Phi$ and an $\ai$-decomposed form of\/ $\Phi$:
\[
\vlder{}{\SKS\setminus\{\aid,\aiu\}}
{
 \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(d_l.\bar d_l)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(d_1.\bar d_1)}\;.\;\vlinf{}{}{\fff}{\vls(b_m.\bar b_m)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(b_1.\bar b_1)}]
}
{
 \vlsbr(\vlinf{}{}{\vls[a_1.\bar a_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[a_n.\bar a_n]}{\ttt}\;.\;\vlinf{}{}{\vls[c_1.\bar c_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[c_k.\bar c_k]}{\ttt}\;.\;\alpha)
}\quad,
\]
we sometimes want to single out only some of the interaction or cut instances. We therefore also call the following, partially sequentialised, derivation an $\ai$-decomposed form of $\Phi$:
\[
\vlderivation
{
 \vlin{=}{}
 {
  \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(b_m.\bar b_m)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(b_1.\bar b_1)}]
 }
 {
  \vlde{}{\SKS\setminus\{\aid,\aiu\}}
  {
   \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(d_l.\bar d_l)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(d_1.\bar d_1)}\;.\;(b_m.\bar b_m)\;.\;\cdots\;.\;(b_1.\bar b_1)]
  }
  {
   \vlin{=}{}
   {
    \vlsbr([a_1.\bar a_1]\;.\;\cdots\;.\;[a_n.\bar a_n]\;.\;\vlinf{}{}{\vls[c_1.\bar c_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[c_k.\bar c_k]}{\ttt}\;.\;\alpha)
   }
   {
    \vlhy
    {
     \vlsbr(\vlinf{}{}{\vls[a_1.\bar a_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[a_n.\bar a_n]}{\ttt}\;.\;\alpha)
    }
   }
  }
 }
}\quad.
\]
\end{convention}
%-----------

%----------------------------------------------
\begin{theorem}\label{theorem:aiDecomposedForm}
Given a derivation $\Phi$, an $\ai$-decomposed form of\/ $\Phi$ whose size depends at most cubically on the size of $\Phi$ can be constructed.
\end{theorem}
\begin{proof}
Using Lemma~\vref{lemma:SuperSwitch} apply, from top-to-bottom and left-to-right, the following transformations to each of the identity and cut instances in $\Phi$:
\[
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlde{\Psi}{}{\xi\left\{\vlinf{}{}{\vls[a.{\bar a}]}{\ttt}\right\}}
  {
   \vlhy{\alpha}
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlin{\ssu}{}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlhy{\vlsbr(\vlinf{}{}{\vls[a.{\bar a}]}{\ttt}\;\;.\;\;\vlder{\Psi}{}{\xi\{\ttt\}}{\alpha})}
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlde{\Psi}{}{\xi\left\{\vlinf{}{}{\fff}{\vls(a.{\bar a})}\right\}}
  {
   \vlhy{\alpha}
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlin{\ssd}{}{\vlsbr[\vlder{\Psi'}{}{\beta}{\xi\{\fff\}}\;\;.\;\;\vlinf{}{}{\fff}{\vls(a.{\bar a})}]}
 {
  \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
  {
   \vlhy{\alpha}
  }
 }
}\quad
\]
to obtain an $\ai$-decomposed form of $\Phi$. The size of the $\ai$-decomposed form obtained in this way depends at most cubically on the size of $\Phi$, since, by Lemma~\vref{lemma:SuperSwitch}, each of the transformations increase the size of the derivation at most quadratically and the number of transformations is bound by the size of $\Phi$.
\end{proof}

\begin{remark}\label{remakr:aiDecomposedFormUnique}
The only reason to insist on performing the transformations in the proof of Theorem~\vref{theorem:aiDecomposedForm} in a certain order is to ensure that the resulting derivation is unique. The uniqueness is useful in the following definition.
\end{remark}

\begin{definition}\label{definition:TheAiDecomposedForm}
Given a derivation $\Phi$, the $\ai$-decomposed form of $\Phi$ obtained as described in the proof of Theorem~\vref{theorem:aiDecomposedForm} is called \emph{the} (\emph{canonical}) \emph{$\ai$-decomposed form of\/ $\Phi$}\index{$\ai$-decomposed form!canonical}.
\end{definition}