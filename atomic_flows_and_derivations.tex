\subsection{Extracting Flows from Derivations}\label{subsection:ExtractingFlowsFromDerivations}

Let us see how to extract atomic flows from derivations. Given an $\SKS$ derivation $\Phi$, we obtain, by the following prescriptions, a unique atomic flow $\phi$, such that there is a surjective map between atom occurrences in $\Phi$ and edges of $\phi$:
\begin{itemize}
%-------------------
\item Each structural inference step in $\Phi$ is associated with one and only one vertex in $\phi$, such that active atom occurrences in the rule instance map to edges incident with the vertex. The correspondence is indicated in Figure~\ref{figure:AtomicFlowVertices}. For example, the flow associated with the inference step at the left is indicated at the right:
\[
\vlinf\acd
      {}
      {\vls(a^\one.[b^\two.a^\five])}
      {\vls(a^\one.[b^\two.[a^\three.a^\four]])}
\qquad\text{and}\qquad
%\vcenter{\hbox{\includegraphics{Figures/figStrEx}}}
\quad.
\]
Note that the nonactive atoms are `traced' by associating each trace with one edge; this corresponds well to abbreviating, say, the inference step $\vldownsmash{\vlinf\acd{}{\xi\vlscn[a]}{\xi\vlscn[a.a]}}$ by $\xi\left\{\vlinf{}{}a{\vls[a.a]}\right\}$.
%-------------------
\item For each other inference step in $\Phi$, all the atom occurrences in the premiss are respectively mapped to the same edges of $\phi$ as the atom occurrences in the conclusion. For example, the flow associated with the inference step
\[
\vlinf\med
      {}
      {\vls(a^\one.([b^\two.d^\four]).([c^\three.e^\five]))}
      {\vls(a^\one.[(b^\two.c^\three).(d^\four.e^\five)])}
\qquad\text{is}\qquad
%\vcenter{\hbox{\includegraphics{Figures/figNonStrEx}}}
\quad.
\]
\end{itemize}
The flow $\phi$ so obtained is called the atomic flow \emph{associated with} the derivation $\Phi$. We show three examples in Figure~\ref{figure:ExampleAtomicFlows}: in the top row we see three $\SKS$ derivations in the standard CoS syntax; in the row below, we show the same derivations in the Formalism A notation; in the bottom row, we see the three corresponding atomic flows.

\newcommand{\RD}[1]{{\color{Red}#1}}
\newcommand{\GR}[1]{{\color{Green}#1}}
\newcommand{\DO}[1]{{\color{DarkOrchid}#1}}
\newcommand{\PR}[1]{{\color{ProcessBlue}#1}}
\newcommand{\MG}[1]{{\color{Magenta}#1}}
\newcommand{\SG}[1]{{\color{SpringGreen}#1}}
\newcommand{\RS}[1]{{\color{RawSienna}#1}}
\newcommand{\YO}[1]{{\color{YellowOrange}#1}}
\newcommand{\PW}[1]{{\color{Periwinkle}#1}}
%-------------------------------------------------------------------------------
\begin{figure}
\[
%---------------------------------------
\begin{array}{@{}c@{}c@{}c@{}}
\vlderivation                                                {
\vlin=   {}{\ttt                                  }         {
\vlin\aiu{}{\vls[\fff.\ttt]                       }        {
\vlin=   {}{\vls[(\GR{a}.\RD{\bar a}).\ttt]       }       {
\vlin\swi{}{\vls[[(\RD{\bar a}.\GR{a}).\ttt].\ttt]}      {
\vlin=   {}{\vls[(\RD{\bar a}.[\GR{a}.\ttt]).\ttt]}     {
\vlin\swi{}{\vls[([\GR{a}.\ttt].\RD{\bar a}).\ttt]}    {
\vlin=   {}{\vls([\GR{a}.\ttt].[\RD{\bar a}.\ttt])}   {
\vlin\med{}{\vls([\GR{a}.\ttt].[\ttt.\RD{\bar a}])}  {
\vlin=   {}{\vls[(\GR{a}.\ttt).(\ttt.\RD{\bar a})]} {
\vlin\aid{}{\vls[\GR{a}.\RD{\bar a}]              }{
\vlhy      {\ttt                                  }}}}}}}}}}}}
\qquad&
%-------------------
\vlderivation                                                              {
\vlin\aiu{}
   {\vls(\DO{a}.\fff)                                            }        {
\vlin=   {}
   {\vls(\DO{a}.(\PR{a}.\MG{\bar a}))                            }       {
\vlin\acu{}
   {\vls((\DO{a}.\PR{a}).\MG{\bar a})                            }      {
\vlin=   {}
   {\vls(\SG{a}.\MG{\bar a})                                     }     {
\vlin\aiu{}
   {\vls([\fff.\SG{a}].\MG{\bar a})                              }    {
\vlin\acd{}
   {\vls([(\RD{a}.\RS{\bar a}).\SG{a}].\MG{\bar a})              }   {
\vlin\swi{}
   {\vls([(\RD{a}.[\GR{\bar a}.\YO{\bar a}]).\SG{a}].\MG{\bar a})}  {
\vlin=   {}
   {\vls((\RD{a}.[[\GR{\bar a}.\YO{\bar a}].\SG{a}]).\MG{\bar a})} {
\vlin\aid{}
   {\vls((\RD{a}.[\GR{\bar a}.[\YO{\bar a}.\SG{a}]]).\MG{\bar a})}{
\vlhy        
   {\vls((\RD{a}.[\GR{\bar a}.\ttt]).\MG{\bar a})                }}}}}}}}}}}
\qquad&
%-------------------
\vlderivation                                                            {
\vlin=   {}{\vls(([\RS{a}.\YO{b}].\PW{a}).([\GR{a}.\DO{b}].\SG{a}))}    {
\vlin\med{}{\vls(([\RS{a}.\YO{b}].[\GR{a}.\DO{b}]).(\PW{a}.\SG{a}))}   {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].(\PW{a}.\SG{a}))}  {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].\MG{a})         } {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).\PR{b}].\MG{a})                  }{
\vlhy      {\vls([\RD{a}.\PR{b}].\MG{a})                           }}}}}}}
\\
\noalign{\bigskip}
%---------------------------------------
\vlderivation                                                      {
\vlin\swi{}{\vlsbr[\vlinf{\swi}
                         {}
                         {\vls[\vlinf{}
                                     {}
                                     {\fff}
                                     {\vls(\GR{a}.\RD{\bar a})}
                              \;.\;
                              \ttt]}
                         {\vls([\GR{a}.\ttt].\RD{\bar a})}
                  \;\;.\;\;
                   \ttt
                  ]                                            }  {
\vlin\med{}{\vls([\GR{a}.\ttt].[\ttt.\RD{\bar a}])             } {
\vlin{}  {}{\vls[\GR{a}.\RD{\bar a}]                           }{
\vlhy      {\ttt                                               }}}}}
\qquad&
%-------------------
\vlinf=
      {}
      {\vls(\DO{a}\;.\;\vlinf{}{}\fff{\vls(\PR{a}.\MG{\bar a})})}      
      {\vlsbr(\vlinf\swi
                    {}
                    {\vls[\vlinf{}
                                {}
                                \fff
                                {\vls(\RD{a}
                                     \;.\;\vlinf{}
                                            {}
                                            {\RS{\bar a}}
                                            {\vls[\GR{\bar a}.\YO{\bar a}]}
                                     )}
                         \;\;.\;\;
                         \vlinf{}{}{\vls(\DO{a}.\PR{a})}{\SG{a}}
                         ]}
                    {\vls(\RD{a}
                         \;.\;[\GR{\bar a}
                          \;.\;\vlinf{}
                                 {}
                                 {\vls[\YO{\bar a}.\SG{a}]}
                                 \ttt
                          ]
                         )}
            \;\;\;\;.\;\;\;\;
            \MG{\bar a}
            )}
\qquad&
%-------------------
\vls(\vlinf\med
           {}
           {\vls([\RS{a}.\YO{b}].[\GR{a}.\DO{b}])}
           {\vls[\vlinf{}{}{\vls(\RS{a}.\GR{a})}{\RD{a}}
                \;.\;{\vlinf{}{}{\vls(\YO{b}.\DO{b})}{\PR{b}}}
                ]}
    \;\;.\;\;
     \vlinf{}{}{\vls(\PW{a}.\SG{a})}{\MG{a}}
    )
\\
\noalign{\bigskip}
%---------------------------------------
\vcenter{\hbox{\includegraphics{Figures/flowExtract1}}}
\qquad&
%-------------------
\vcenter{\hbox{\includegraphics{Figures/flowExtract2}}}
\qquad&
%-------------------
\vcenter{\hbox{\includegraphics{Figures/flowExtract3}}}
\end{array}
\]
\caption{Examples of derivations in the calculus of structures (top row), their representation in Formalism A notation (middle row), and their associated atomic flows (bottom row).}
\label{figure:ExampleAtomicFlows}
\end{figure}

%--------------------------------------------------
\begin{definition}\label{definiton:FlowRestriction}
Given a derivation $\Phi$ with atomic flow $\phi$, and an atom $a$, the \emph{restriction of $\phi$ to $a$}\index{flow!restriction to atom} is the largest subflow $\phi_a$ of $\phi$, such that every edge of $\phi_a$ is mapped to from $a$ or $\bar a$.
\end{definition}
%---------------

%--------------
\begin{example}\label{example:FlowRestriction}
Consider the rightmost derivation and its associated atomic flow in Figure~\ref{figure:ExampleAtomicFlows}. The restriction of this flow to $a$ is:
\[
\vcenter{\hbox{\includegraphics{Figures/flowExtract4}}}
\]
\end{example}
%------------

Perhaps surprisingly, it can be proved that every flow is associated with infinitely many $\SKS$ derivations (see \cite{GuglGund:07:Normalis:lr}).

As we mention at the beginning of this section, atomic flows help in selectively substituting for atom occurrences. In fact, given a derivation and its associated flow, we can use edges and boxes to individuate atom occurrences in the derivation, and then possibly substitute for them. For example, let us suppose that we are given the following associated derivation and flow:
\[
\Phi=
\vlsbr[\vlderivation                                              {
       \vlin{    }{}\fff                                         {
       \vlin{\med}{}{\vls(\vlinf{}{}a{\vls[a.a]}
                         .\vlinf={}{\bar a}{\vls[\fff.\bar a]})}{
       \vlhy        {\vls[(a.\fff).(a
                                   .\vlinf{}{}{\bar a}\fff)]   }}}}
      \vlx.\vlx\bar a]
\qquad\text{and}\qquad
\vcenter{\hbox{\includegraphics{Figures/substEx}}}
\quad.
\]
We can then distinguish between the three occurrences of $\bar a$ that are mapped to edge $\one$ and the one that is not, as in
\[
\Phi=
\vlsbr[\vlderivation                                                        {
       \vlin{    }{}\fff                                                   {
       \vlin{\med}{}{\vls(\vlinf{}{}a{\vls[a.a]}
                         .\vlinf={}{\bar a^\one}{\vls[\fff.\bar a^\one]})}{
       \vlhy        {\vls[(a.\fff).(a
                                   .\vlinf{}{}{\bar a^\one}\fff)]        }}}}
      \vlx.\vlx\bar a]
\quad.
\]

We generalise this labelling mechanism to boxes. For example, we can use a different representation of the flow of $\Phi$ to individuate two classes $a^\phi$ and $\bar a^\phi$ of atom occurrences, as follows:
\[
\Phi=
\vlsbr[\vlderivation                                                        {
       \vlin{    }{}\fff                                                   {
       \vlin{\med}{}{\vls(\vlinf{}{}{a^\phi}{\vls[a.a]}
                         .\vlinf={}{\bar a^\phi}{\vls[\fff.\bar a^\phi]})}{
       \vlhy        {\vls[(a.\fff).(a
                                   .\vlinf{}{}{\bar a^\phi}\fff)]        }}}}
      \vlx.\vlx\bar a^\phi]
\qquad\text{and}\qquad
\vcenter{\hbox{\includegraphics{Figures/substExBox}}}
\quad;
\]
we can also substitute for these occurrences, for example by $\{\bar a^\phi/\fff\}$; such a situation occurs in the proof of Theorem~\vref{theorem:SoundIsolatedSubflowRemoval}. Note that simply substituting $\fff$ for $\bar a^\phi$ would invalidate this derivation because it would break the cut and weakening instances; however Proposition~\vref{proposition:DerivationSubstitution} specifies how to fix such broken instances.

%-------------------------------------------------------------------------------
\begin{notation}\label{notation:FormulaSubstitution}
Given a formula $\alpha$ in a derivation whose associated atomic flow contains a flow $\phi$, we indicate with $a^\phi$ every occurrence of the atom $a$ in $\alpha$ whose associated edge is in $\phi$. So, as in the following Proposition~\ref {proposition:DerivationSubstitution}, $\alpha\{a^\phi/\gamma\}$ stands for the formula $\alpha$ where the atom occurrences of $a$, whose associated edges are in $\phi$, are substituted with formula $\gamma$.
\end{notation}

%------------------------------------------------------------
\begin{proposition}\label{proposition:DerivationSubstitution}
Given a derivation\/ $\vlder\Phi\SKS{\beta}\alpha$, let its associated flow have shape
\[
\vcenter{\hbox{\includegraphics{Figures/propSubst1}}}\quad,
\]
such that $\phi$ is a connected component whose edges are each associated with atom $a$; then, for any formula $\gamma$, there exists a derivation
\[
\vlder\Psi\SKS{\beta \{a^\phi/\gamma\}}
              {\alpha\{a^\phi/\gamma\}}
\]
whose associated flow is
\[
\vcenter{\hbox{\includegraphics{Figures/propSubst2}}}
\quad,
\]
where $n$ is the number of atom occurrences in $\gamma$; moreover, the size of\/ $\Psi$ depends linearly on the size of\/ $\Phi$ and quadratically on the size of $\gamma$.
\end{proposition}
%----------------

%-------------------------------------------------------------------------------
\begin{proof}
We can proceed by structural induction on $\Phi$. For every formula in $\Phi$ we substitute $a^\phi$ with $\gamma$. Since all the edges in $\phi$ are mapped to from $a$ (and not $\bar a$), we know that all the vertices in $\phi$ are mapped to from instances of $\acd$, $\acu$, $\awd$ and $\awu$. We substitute every instance of $\acd$, $\acu$, $\awd$ and $\awu$ where $a^\phi$ appears, by $\cod$, $\cou$, $\wed$, $\weu$, respectively, with $\gamma$ in the place of $a^\phi$. The result then follows by Proposition~\vref{proposition:GenericStructural}.
\end{proof}
%----------

%---------------
\begin{notation}\label{notation:DerivationSubstitution}
The derivation $\Psi$ obtained in the proof of Propostion~\vref{proposition:DerivationSubstitution} is denoted $\Phi\{a^\phi/\gamma\}$.
\end{notation}
%-------------

%-------------
\begin{remark}\label{remark:ExtendDerivationSubstitution}
The notion of substitution can be extended to allow $\phi$ to contain interaction and cut vertices, but we shall not need that in this article.
\end{remark}
%-----------

%=================================================================
\subsection{A Normal Form of Derivation}\label{subsection:DerNormalForm}

In this section we introduce the \emph{$\ai$-decomposed form} of a derivation. The reason for introducing this normal form is that we will often find it convenient to assume that identity instances appear at the top and cut instances appear at the bottom of a derivation. The important features of this normal form is that a derivation can be transformed into $\ai$-decomposed form without changing its atomic flow, and without significantly changing its size.

\begin{definition}\label{definition:aiDecomposedForm}
Given two derivations
\[
\vlder{\Phi}{}{\beta}{\alpha}
\quad\mbox{and}\quad
\Psi\;=\;
\vlder{}{\SKS\setminus\{\aid,\aiu\}}
{
 \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(b_m.\bar b_m)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(b_1.\bar b_1)}]
}
{
 \vlsbr(\vlinf{}{}{\vls[a_1.\bar a_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[a_n.\bar a_n]}{\ttt}\;.\;\alpha)
}\quad,
\]
for some atoms $a_1,\dots,a_n,b_1,\dots,b_m$, such that $\Phi$ and $\Psi$ have the same atomic flow, we say that $\Psi$ is an \emph{$\ai$-decomposed form of\/ $\Phi$}\index{$\ai$-decomposed form}.
\end{definition}

\begin{convention}\label{convention:AlternativeAiDecomposedForm}
Given a derivation $\Phi$ and an $\ai$-decomposed form of\/ $\Phi$:
\[
\vlder{}{\SKS\setminus\{\aid,\aiu\}}
{
 \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(d_l.\bar d_l)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(d_1.\bar d_1)}\;.\;\vlinf{}{}{\fff}{\vls(b_m.\bar b_m)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(b_1.\bar b_1)}]
}
{
 \vlsbr(\vlinf{}{}{\vls[a_1.\bar a_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[a_n.\bar a_n]}{\ttt}\;.\;\vlinf{}{}{\vls[c_1.\bar c_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[c_k.\bar c_k]}{\ttt}\;.\;\alpha)
}\quad,
\]
we sometimes want to single out only some of the interaction or cut instances. We therefore also call the following, partially sequentialised, derivation an $\ai$-decomposed form of $\Phi$:
\[
\vlderivation
{
 \vlin{=}{}
 {
  \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(b_m.\bar b_m)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(b_1.\bar b_1)}]
 }
 {
  \vlde{}{\SKS\setminus\{\aid,\aiu\}}
  {
   \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(d_l.\bar d_l)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(d_1.\bar d_1)}\;.\;(b_m.\bar b_m)\;.\;\cdots\;.\;(b_1.\bar b_1)]
  }
  {
   \vlin{=}{}
   {
    \vlsbr([a_1.\bar a_1]\;.\;\cdots\;.\;[a_n.\bar a_n]\;.\;\vlinf{}{}{\vls[c_1.\bar c_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[c_k.\bar c_k]}{\ttt}\;.\;\alpha)
   }
   {
    \vlhy
    {
     \vlsbr(\vlinf{}{}{\vls[a_1.\bar a_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[a_n.\bar a_n]}{\ttt}\;.\;\alpha)
    }
   }
  }
 }
}\quad.
\]
\end{convention}
%-----------

%----------------------------------------------
\begin{theorem}\label{theorem:aiDecomposedForm}
Given a derivation $\Phi$, an $\ai$-decomposed form of\/ $\Phi$ whose size depends at most cubically on the size of $\Phi$ can be constructed.
\end{theorem}
\begin{proof}
Using Lemma~\vref{lemma:SuperSwitch} apply, from top-to-bottom and left-to-right, the following transformations to each of the identity and cut instances in $\Phi$:
\[
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlde{\Psi}{}{\xi\left\{\vlinf{}{}{\vls[a.{\bar a}]}{\ttt}\right\}}
  {
   \vlhy{\alpha}
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlin{\ssu}{}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlhy{\vlsbr(\vlinf{}{}{\vls[a.{\bar a}]}{\ttt}\;\;.\;\;\vlder{\Psi}{}{\xi\{\ttt\}}{\alpha})}
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlde{\Psi}{}{\xi\left\{\vlinf{}{}{\fff}{\vls(a.{\bar a})}\right\}}
  {
   \vlhy{\alpha}
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlin{\ssd}{}{\vlsbr[\vlder{\Psi'}{}{\beta}{\xi\{\fff\}}\;\;.\;\;\vlinf{}{}{\fff}{\vls(a.{\bar a})}]}
 {
  \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
  {
   \vlhy{\alpha}
  }
 }
}\quad
\]
to obtain an $\ai$-decomposed form of $\Phi$. The size of the $\ai$-decomposed form obtained in this way depends at most cubically on the size of $\Phi$, since, by Lemma~\vref{lemma:SuperSwitch}, each of the transformations increase the size of the derivation at most quadratically and the number of transformations is bound by the size of $\Phi$.
\end{proof}

\begin{remark}\label{remakr:aiDecomposedFormUnique}
The only reason to insist on performing the transformations in the proof of Theorem~\vref{theorem:aiDecomposedForm} in a certain order is to ensure that the resulting derivation is unique. The uniqueness is useful in the following definition.
\end{remark}

\begin{definition}\label{definition:TheAiDecomposedForm}
Given a derivation $\Phi$, the $\ai$-decomposed form of $\Phi$ obtained as described in the proof of Theorem~\vref{theorem:aiDecomposedForm} is called \emph{the} (\emph{canonical}) \emph{$\ai$-decomposed form of\/ $\Phi$}\index{$\ai$-decomposed form!canonical}.
\end{definition}