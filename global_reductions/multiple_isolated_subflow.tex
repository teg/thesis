\newcommand{\MISR}{\mathsf{MISR}}

\TODO{Redo intro.}

We will see later how a derivation containing $2n$ atoms can be weakly streamlined by two applications of $\Simpl$ and two applications of $\MISR_n$.

The operator is defined in terms of the following flow reduction. Unlike the flow reductions of the preceeding sections, we here present a reductions which depends on several parameters.

In Subsection~\vref{subsubsection:ThresholdFormulae}, we present one possible combination of valid parameters, which yeields quasipolynomial streamlining. We conjecture that by finding different parameters we will be able to obtain more efficient versions of this reduction. In particular, we hope to be able to obtain polynomial streamlining.

\newcommand{\Gammasf}{\mathsf\Gamma}
%----------------------------------
\newcommand{\frmis}{{\mathsf{mis}}}
\begin{definition}\label{definition:MultipleIsolatedSubflowsRemoval}
For every $n>0$, given
\begin{itemize}
\item atoms $a_1$, $\dots$, $a_n$;
\item an $N>0$;
\item for $0\le k\le N$, formulae $\gamma_{k,1}$, $\dots$, $\gamma_{k,n}$, such that
\begin{itemize}
 \item $\gamma_{0,1}=\cdots=\gamma_{0,n}=\ttt$, and
 \item $\gamma_{N,1}=\cdots=\gamma_{N,n}=\fff$; and
\end{itemize}
\item for $1\le k\le N$, a derivation
\[
\Gammasf_k\quad=\quad
\vlder{}{\SKS\setminus\{\aid,\aiu\}}
{
 \vls([a_1.\gamma_{k,1}].\cdots.[a_n.\gamma_{k,n}])
}
{
 \vls[(a_1.\gamma_{k-1,1}).\cdots.(a_n.\gamma_{k-1,n})]
}\quad,
\]
\end{itemize}
let, for $1\le k\le N$, $\eta_k$ be the atomic flow of\/ $\Gammasf_k$, and let
\[
\mu_k\;=\;
\atomicflow
{
(  4,  6)*{\afvjm4};
(  4,  0)*{\affr{8}{8}};
(  8,  2)*{\aflabelleft{f_{1,1}(\psi_1)}};
(  4, -6)*{\afvjm4};
( 10,  0)*{\cdots};
( 16,  6)*{\afvjm4};
( 16,  0)*{\affr{8}{8}};
( 20,  2)*{\aflabelleft{f_{1,l_1}(\psi_1)}};
( 16, -6)*{\afvjm4};
( 22,  0)*{\cdots};
( 28,  6)*{\afvjm4};
( 28,  0)*{\affr{8}{8}};
( 32,  2)*{\aflabelleft{f_{n,1}(\psi_n)}};
( 28, -6)*{\afvjm4};
( 34,  0)*{\cdots};
( 40,  6)*{\afvjm4};
( 40,  0)*{\affr{8}{8}};
( 44,  2)*{\aflabelleft{f_{n,l_n}(\psi_n)}};
( 40, -6)*{\afvjm4};
}
\quad,
\]
where, for $1\le i\le n$, $l_i$ is the number of atom occurrences in $\gamma_{k,i}$, we define the reduction $\to_{\frmis_n}$ (where $\frmis$ stands for \emph{multiple isolated subflows}\index{Multiple Isolated Subflows Remover!reduction}) as follows, for any atomic flow $\phi$ and any connected atomic flows $\psi_1$, $\dots$, $\psi_n$ that do not contain interaction or cut vertices:
\[
\atomicflow{
(-12,  8)*{\afvjdm8{}{\boldsymbol\epsilon}};
(  4, 10)*{\afaidex{}{}{}{}{}{}{20}{4}};
( -6,  5)*{\afvj2};
( -4,  6)*{\cdots};
( 14,  5)*{\afvj2};
(  1,  8)*{\afaidex{}{}{}{}{}{}{6}{4}};
( -7,  0)*{\affr{12}{8}};
( -1,  2)*{\aflabelleft{\phi}};
(  4,  0)*{\affr{6}{8}};
(  7,  2)*{\aflabelleft{\psi_1}};
(  9,  0)*{\cdots};
( 14,  0)*{\affr{6}{8}};
( 17,  2)*{\aflabelleft{\psi_n}};
(  1, -8)*{\afaiuex{}{}{}{}{}{}{6}{4}};
( -6, -5)*{\afvj2};
( -4, -6)*{\cdots};
( 14, -5)*{\afvj2};
(  4,-10)*{\afaiuex{}{}{}{}{}{}{20}{4}};
(-12, -8)*{\afvjum8{}{\boldsymbol\iota}};
}
\quad\to_{\frmis_n}\quad
\atomicflow{
(-12, 56)*{\afvjm4};
(-12, 50)*{\copy\contrup};
(-12, 50)*{\affr{16}{8}};
( -5, 44)*{\afvjdm4{}{f_1(\boldsymbol\epsilon)}};
( -7, 34)*{\afcjlm{4}{24}};
(-12, 42)*{\cdots};
(-10,  2)*{\afcjlm{10}{32}};
(-15, 32)*{\afvjm{28}};
(-12,-13)*{\afcjlm{14}{42}};
(-19, 27)*{\afvjm{38}};
%--
( 5, 46)*{\afawdm{}{}{}{}};
( 0, 38)*{\affr{12}{8}};
( 6, 40)*{\aflabelleft{f_1(\phi)}};
(-5, 32.5)*{\aflabelright{f_1(\boldsymbol\iota)}};
( 5, 33)*{\afvjm2};
( 9, 28)*{\affr{10}{8}};
(14, 30)*{\aflabelleft{\eta_1}};
( 5, 23)*{\afvjm2};
(11, 23)*{\afvjm2};
(-5, 24.5)*{\aflabelright{f_2(\boldsymbol\epsilon)}};
( 0, 18)*{\affr{12}{8}};
( 6, 20)*{\aflabelleft{f_2(\phi)}};
(-5, 12.5)*{\aflabelright{f_2(\boldsymbol\iota)}};
( 5, 13)*{\afvjm2};
(11, 13)*{\afvjm2};
(11, 18)*{\affr{6}{8}};
(14, 20)*{\aflabelleft{\mu_1}};
( 9,  8)*{\affr{10}{8}};
(14, 10)*{\aflabelleft{\eta_2}};
( 5,  3)*{\afvjm2};
(11,  3)*{\afvjm2};
%-
( 0,  1)*{\vdots};
%-
( 5, -3)*{\afvjm2};
(11, -3)*{\afvjm2};
( 9, -8)*{\affr{10}{8}};
(14, -6)*{\aflabelleft{\eta_{N-1}}};
( 5,-13)*{\afvjm2};
(11,-13)*{\afvjm2};
(-5,-11.5)*{\aflabelright{f_N(\boldsymbol\epsilon)}};
( 0,-18)*{\affr{12}{8}};
( 6,-16)*{\aflabelleft{f_N(\phi)}};
(-5,-23.5)*{\aflabelright{f_N(\boldsymbol\iota)}};
(11,-18)*{\affr{6}{8}};
(14,-16)*{\aflabelleft{\mu_{N-1}}};
( 5,-23)*{\afvjm2};
(11,-23)*{\afvjm2};
( 9,-28)*{\affr{10}{8}};
(14,-26)*{\aflabelleft{\eta_N}};
( 5,-33)*{\afvjm2};
(-5,-31.5)*{\aflabelright{f_{N+1}(\boldsymbol\epsilon)}};
( 0,-38)*{\affr{12}{8}};
( 6,-36)*{\aflabelleft{f_{N+1}(\phi)}};
( 5,-46)*{\afawum{}{}{}{}};
%--
(-12, 13)*{\afcjrm{14}{42}};
(-19,-27)*{\afvjm{38}};
(-10, -2)*{\afcjrm{10}{32}};
(-15,-32)*{\afvjm{28}};
(-12,-42)*{\cdots};
( -7,-34)*{\afcjrm{4}{24}};
( -5,-44)*{\afvjum4{}{f_{N+1}(\boldsymbol\iota)}};
(-12,-50)*{\affr{16}{8}};
(-12,-50)*{\copy\contrdown};
(-12,-56)*{\afvjm4};
}\quad.
\]
\end{definition}
%---------------

\begin{remark}
The reduction ${\to_{\frmis_n}}$ denoted as if it only depends on $n$, this is a misuse of notation, and we will take it for granted that we also have the other parameters whenever we use ${\to_{\frmis_n}}$.
\end{remark}

%------------------------------------------------------------------
\begin{theorem}\label{theorem:SoundMultipleIsolatedSubflowsRemoval}
For every $n>0$, reduction\/ ${\to_{\frmis_n}}$ is sound; moreover, if\/ $\Phi\to_{\frmis_n}\Psi$, then the size of\/ $\Psi$ depends linearly on $N$, polynomially on the size of\/ $\Phi$ and at most polynomially on\/ $\max\{\size{\Gammasf_1},\dots,\size{\Gammasf_N}\}$.
\end{theorem}

\begin{proof}
Let $\Phi$ be a derivation with flow $\phi'$, such that $\phi'\to_{\frmis_n}\psi'$. We show that there exists a derivation $\Psi$ with flow $\psi'$ and with the same premiss and conclusion as $\Phi$. In the following, we refer to the figures in Definition~\vref{definition:MultipleIsolatedSubflowsRemoval}.

Since each of $\psi_1$, $\dots$, $\psi_n$ is connected, we assume, by Convention~\vref{convention:AlternativeAiDecomposedForm}, that the following derivation is an $\ai$-decomposed form of $\Phi$:
\[
\vlder{\Phi'}{}
{
 \vls[\beta\;.\;\vlinf{}{}{\fff}{\vls(a_1.\bar a_1^{\psi_1})}\;.\;\vlinf{}{}{\fff}{\vls(a_n.\bar a_n^{\psi_n})}]
}
{
 \vls(\vlinf{}{}{\vls[a_1.\bar a_1^{\psi_1}]}{\ttt}\;.\;\vlinf{}{}{\vls[a_n.\bar a_n^{\psi_n}]}{\ttt}\;.\;\alpha)
}\quad,
\]
for some atoms $a_1$, $\dots$, $a_n$ (that, without loss of generality, we assume coincide with the atoms given in Definition~\ref{definition:MultipleIsolatedSubflowsRemoval}) and formulae $\alpha$ and $\beta$.

For every $0\le k\le N$, we obtain the derivation $\Phi_k$ from $\Phi'$ as follows:
\[
\Phi_k\quad=\quad
\vlder{\Phi'\{\bar a_1^{\psi_1}/\gamma_{k,1},\dots,\bar a_n^{\psi_n}/\gamma_{k,n}\}}{}
{
 \vlsbr[\beta.(a_1.\gamma_{k,1}).\cdots.(a_n.\gamma_{k,n})]
}
{
 \vls([a_1.\gamma_{k,1}].\cdots.[a_n.\gamma_{k,n}].\alpha)
}
\]
Since each of $\psi_1$, $\dots$, $\psi_n$ is connected and contains no interaction or cut vertices, the mapping from occurrences of $\bar a_i^{\psi_i}$ to edges of $\psi_i$ is surjective. Hence, we know that $\Phi_k$ has atomic flow
\[
\atomicflow{
(-5, 6)*{\afvjm4};
( 1, 6)*{\afvj4};
( 3, 6)*{\cdots};
( 5, 6)*{\afvj4};
(11, 6)*{\afvjm4};
( 0, 0)*{\affr{12}{8}};
( 6, 2)*{\aflabelleft{f_i(\phi)}};
(11, 0)*{\affr{6}{8}};
(14, 2)*{\aflabelleft{\mu_{k-1}}};
(-5,-6)*{\afvjm4};
( 1,-6)*{\afvj4};
( 3,-6)*{\cdots};
( 5,-6)*{\afvj4};
(11,-6)*{\afvjm4};
}\quad.
\]
We combine $\Phi_0$, $\dots$, $\Phi_N$, $\Gammasf_1$, $\dots$, $\Gammasf_N$ to get the desired derivation $\Psi$ with atomic flow $\psi'$ and the same premiss and conclusion as $\Phi$:
\[
\vlderivation
{
 \vlin{\cod}{}
 {
  \beta
 }
 {
  \vlin{\swi}{}
  {
   \vls
   [
    \vlinf{\cod}{}{\beta}{\vls[\beta.\beta]}
   \;\;\;.\;\;\;
    \vlder{\Phi_N}{}
    {
     \vlsbr[\beta\;.\;(\vlinf{}{}{\ttt}{a_1}\;.\;\fff)\;.\;\cdots\;.\;(\vlinf{}{}{\ttt}{a_n}\;.\;\fff)]
    }
    {
     \vls([a_1.\fff].\cdots.[a_n.\fff].\alpha)
    }
   ]
  }
  {
   \vlin{\swi}{}
   {
    \vls
    (
     [
      \vlinf{\cod}{}{\beta}{\vls[\beta.\beta]}
     \;\;\;\;.\;\;\;\;
      \vlder{\Phi_{N-1}}{}
      {
       \vlsbr
       [
        \beta
       \;\;.\;\;
        \vlder{\Gammasf_N}{}
        {
         \vlsmallbrackets\vls([a_1.\fff].\cdots.[a_n.\fff])
        }
        {
         \vlsmallbrackets\vls[(a_1.\gamma_{N-1,1}).\cdots.(a_n.\gamma_{N-1,n})]
        }
       ]
      }
      {
       \vlsmallbrackets\vls([a_1.\gamma_{N-1,1}].\cdots.[a_n.\gamma_{N-1,n}].\alpha)
      }
     ]
    \;\;\;\;.\;\;\;\;
     \alpha
    )
   }
   {
    \vlin{\swi}{}
    {
     \vdots
    }
    {
     \vlin{\swi}{}
     {
      \vls
      (
       [
        \beta
       \;\;\;\;.\;\;\;\;
        \vlder{\Phi_1}{}
        {
         \vlsbr
         [
          \beta
         \;\;.\;\;
          \vlder{\Gammasf_2}{}
          {
           \vlsmallbrackets\vls([a_1.\gamma_{2,1}].\cdots.[a_n.\gamma_{2,n}])
          }
          {
           \vlsmallbrackets\vls[(a_1.\gamma_{1,1}).\cdots.(a_n.\gamma_{1,n})]
          }
         ]
        }
        {
         \vlsmallbrackets\vls([a_1.\gamma_{1,1}].\cdots.[a_n.\gamma_{1,n}].\alpha)
        }
       ]
      \;\;\;\;.\;\;\;\;
       \vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha}
      )
     }
     {
      \vlin{\cou}{}
      {
       \vls
       (
        \vlder{\Phi_0}{}
        {
         \vlsbr
         [
          \beta
         \;\;.\;\;
          \vlder{\Gammasf_1}{}
          {
           \vlsmallbrackets\vls([a_1.\gamma_{1,1}].\cdots.[a_n.\gamma_{1,n}])
          }
          {
           \vlsmallbrackets\vls[(a_1.\ttt).\cdots.(a_n.\ttt)]
          }
         ]
        }
        {
         \vlsbr([\vlinf{}{}{a_1}{\fff}\;.\;\ttt]\;.\;\cdots\;.\;[\vlinf{}{}{a_n}{\fff}\;.\;\ttt]\;.\;\alpha)
        }
       \;\;\;\;.\;\;\;\;
        \vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha}
       )
      }
      {
       \vlhy{\alpha}
      }
     }
    }
   }
  }
 }
}
\qquad.
\]
Since $\max\{\size{\gamma_{0,1}},\dots,\size{\gamma_{N,n}}\}$ is less than or equal to $\max\{\size{\Gammasf_1},\dots,\size{\Gammasf_N}\}$, we know that the size of $\Phi_0$, $\dots$, $\Phi_N$ depend at most cubically on the size of $\Phi$ and at most quadratically on the size of $\max\{\size{\Gammasf_1},\dots,\size{\Gammasf_N}\}$ by Theorem~\vref{theorem:aiDecomposedForm} and Proposition~\vref{proposition:DerivationSubstitution}, and that the size of $\Psi$ depends at most cubically on the size of $\alpha$ and $\beta$ by Lemma~\vref{lemma:GenericContraction}, so the size of $\Psi$ depends linearly on $N$, polynomially on the size of $\Phi$ and at most polynomially on the size of $\max\{\size{\Gammasf_1},\dots,\size{\Gammasf_N}\}$.
\end{proof}
%----------

%-------------------------------------
\begin{lemma}\label{lemma:MultipleIsolatedSubflowsRemovalPaths}
Given two atomic flows $\phi$ and $\psi$ and an $n>0$, such that $\phi\to_{\frmis_n}\psi$; let $f_1$, $\dots$, $f_{N+1}$ be the isomorphisms and let $\nu_{\ai,1}$, $\dots$, $\nu_{\ai,n}$ be the evidenced cut (resp., interaction) vertices described in Definition~\ref{definition:MultipleIsolatedSubflowsRemoval}; then, given an interaction (resp., cut) vertex $\nu$ in $\psi$, there is an interaction (resp., cut) vertex $\nu'$ in $\phi$, such that
\begin{itemize}
\item for some $1\le i\le N+1$, $\nu=f_i(\nu')$;
\item if there is a path from $\nu$ to $\bot$ (resp., $\top$) in $\psi$, then there is a path from $\nu'$ to $\bot$ (resp., $\top$) in $\phi$; and
\item if there is a cut (resp., interaction) vertex $\hat\nu$ in $\psi$, such that there is a path from $\nu$ to $\hat\nu$ in $\psi$, then there is a cut (resp., interaction) vertex $\hat\nu'$ in $\phi$, such that, for some $1\le i\le N+1$, $\hat\nu=f_i(\nu')$, or, for some $1\le i\le n$, $\hat\nu'=\nu_{\ai,i}$; and there is a path from $\nu'$ to $\hat\nu'$ in $\phi$.
\end{itemize}
\end{lemma}

\begin{proof}
In the following we refer to the figure in Definition~\ref{definition:MultipleIsolatedSubflowsRemoval}:
\begin{itemize}
 \item the statement follows by definition;
 \item any path from $\nu$ to $\top$ (resp., $\bot$) in $\psi$ must contain an edge $\epsilon$, such that, for some upper (resp., lower) edge $\epsilon'$ of $\phi$ and some $1\le i\le N+1$, $f_i(\epsilon')=\epsilon$. Hence, there is a path from $\nu'$ to $\top$ (resp., $\bot$) in $\phi$; and
 \item we have to consider two cases:
 \begin{itemize}
  \item for some $1\le i\le N+1$, $\nu=f_i(\nu')$ and $\hat\nu=f_i(\hat\nu')$, then there is a path from $\nu'$ to $\hat\nu'$ in $\phi$; or
  \item for some $1\le i<j\le N+1$, $\nu=f_i(\nu')$ and $\hat\nu=f_j(\hat\nu')$ (resp., $\nu=f_j(\nu')$ and $\hat\nu=f_i(\hat\nu')$),then, for some $1\le i\le n$, there is a path from $\nu'$ to $\nu_{\ai,i}$ in $\phi$.
 \end{itemize}
\end{itemize}
\end{proof}
%----------

%--------------------------------
\begin{definition}\label{definition:MultipleIsolatedSubflowsRemover}
For every $n>0$, given the atoms, formulae and derivations described in Definition~\vref{definition:MultipleIsolatedSubflowsRemoval}, the \emph{Multiple Isolated Subflow Remover}\index{Multiple Isolated Subflows Remover!operator}, $\MISR_n$, is an operator whose arguments are atoms $a_1$, $\dots$, $a_n$ (that, without loss of generality, we assume coincide with the atoms given in Definition~\ref{definition:MultipleIsolatedSubflowsRemoval}), and a derivation $\Phi$ that is in simple form with respect to $a_1$, $\dots$, $a_n$. If $n=1$ and $\Phi$ is weakly streamlined with respect to $a_1$, then $\MISR_1(\Phi,a_1)=\Phi$; if $n>1$ and, for some $1\le i\le n$, $\Phi$ is weakly streamlined with respect to $a_i$, then $\MISR(\Phi,a_1,\dots,a_n)=\MISR_{n-1}=(\Phi,a_1,\dots,a_{i-1},a_{i+1},\dots,a_n)$; otherwise, consider the following $\ai$-decomposed form of $\Phi$:
\[
\vlder{\Phi'}{}
{
 \vlsbr
 [
  \beta
 \;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a_n^{\psi_n}.\bar a_n)
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a_n^{\psi_n}.\bar a_n)
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a_1^{\psi_1}.\bar a_1)
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a_1^{\psi_1}.\bar a_1)
  }
 ]
}
{
 \vlsbr
 (
  \vlinf{}{}
  {
   \vls[a_1^{\psi_1}.\bar a_1]
  }
  {
   \ttt
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \vls[a_1^{\psi_1}.\bar a_1]
  }
  {
   \ttt
  }
 \;.\;
  \vlinf{}{}
  {
   \vls[a_n^{\psi_n}.\bar a_n]
  }
  {
   \ttt
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \vls[a_n^{\psi_n}.\bar a_n]
  }
  {
   \ttt
  }
 \;.\;
  \alpha
 )
}\quad,
\]
with atomic flow
\[
\atomicflow{
(-12,  8)*{\afvjdm8{}{\boldsymbol\epsilon}};
(  4, 10)*{\afaidmex{}{}{}{}{}{}{20}{4}};
( -6,  5)*{\afvjm2};
( -4,  6)*{\cdots};
( 14,  5)*{\afvjm2};
(  1,  8)*{\afaidmex{}{}{}{}{}{}{6}{4}};
( -7,  0)*{\affr{12}{8}};
( -4,  2)*{\aflabelright{\phi'}};
(  4,  0)*{\affr{6}{8}};
(  4,  2)*{\aflabelright{\psi'_1}};
(  9,  0)*{\cdots};
( 14,  0)*{\affr{6}{8}};
( 14,  2)*{\aflabelright{\psi'_n}};
(  1, -8)*{\afaiumex{}{}{}{}{}{}{6}{4}};
( -6, -5)*{\afvjm2};
( -4, -6)*{\cdots};
( 14, -5)*{\afvjm2};
(  4,-10)*{\afaiumex{}{}{}{}{}{}{20}{4}};
(-12, -8)*{\afvjum8{}{\boldsymbol\iota}};
}
\quad,
\]
where, for $1\le i\le n$, $\psi_i$ is the juxtaposition of all the isolated subflows mapped to from occurrences of $a_i$ in $\Phi$. Consider the derivation
\[
\Psi\;=\;
\vlder{\Phi'}{}
{
 \vlsbr
 [
  \beta
 \;\;\;.\;\;\;
  \vlderivation
  {
   \vlin{}{}
   {
    \fff
   }
   {
    \vlde{}{\{\cod\}}
    {
     \vls(a_n.\bar a_n)
    }
    {
     \vlhy
     {
      \vls[(a_n.\bar a_n).\cdots.(a_n.\bar a_n)]
     }
    }
   }
  }
 \;\;\;.\;\;\;\cdots\;\;\;.\;\;\;
  \vlderivation
  {
   \vlin{}{}
   {
    \fff
   }
   {
    \vlde{}{\{\cod\}}
    {
     \vls(a_1.\bar a_1)
    }
    {
     \vlhy
     {
      \vls[(a_1.\bar a_1).\cdots.(a_1.\bar a_1)]
     }
    }
   }
  }
 ]
}
{
 \vlsbr
 (
  \vlderivation
  {
   \vlde{}{\{\cou\}}
   {
    \vls([a_1.\bar a_1].\cdots.[a_1.\bar a_1])
   }
   {
    \vlin{}{}
    {
     \vls[a_1.\bar a_1]
    }
    {
     \vlhy
     {
      \ttt
     }
    }
   }
  }
 \;\;\;.\;\;\;\cdots\;\;\;.\;\;\;
  \vlderivation
  {
   \vlde{}{\{\cou\}}
   {
    \vls([a_n.\bar a_n].\cdots.[a_n.\bar a_n])
   }
   {
    \vlin{}{}
    {
     \vls[a_n.\bar a_n]
    }
    {
     \vlhy
     {
      \ttt
     }
    }
   }
  }
 \;\;\;.\;\;\;
  \alpha
 )
}\quad,
\]
with atomic flow
\[
\psi''\;=\;
\atomicflow{
(-16, 12)*{\afvjdm{16}{\boldsymbol\epsilon}{}};
(  7, 20)*{\afaidex{}{}{}{}{}{}{34}{4}};
(  4, 18)*{\afaidex{}{}{}{}{}{}{12}{4}};
%-
(-10, 15)*{\afvj2};
(-10, 10)*{\affr68};
(-10, 10)*{\copy\contrup};
(-10,  5)*{\afvjm2};
( -6,  5)*{\cdots};
( -2, 10)*{\affr68};
( -2, 10)*{\copy\contrup};
( -2,  5)*{\afvjm2};
( -9,  0)*{\affr{16}{8}};
( -1,  2)*{\aflabelleft{\phi'}};
(-10, -5)*{\afvjm2};
(-10,-10)*{\affr68};
(-10,-10)*{\copy\contrdown};
(-10,-15)*{\afvj2};
( -6, -5)*{\cdots};
( -2, -5)*{\afvjm2};
( -2,-10)*{\affr68};
( -2,-10)*{\copy\contrdown};
%-
(10, 10)*{\affr68};
(10, 10)*{\copy\contrup};
(10,  5)*{\afvjm2};
(24, 15)*{\afvj2};
(24, 10)*{\affr68};
(24, 10)*{\copy\contrup};
(24,  5)*{\afvjm2};
(10,  0)*{\affr{6}{8}};
(11,  2)*{\aflabelleft{\psi'_1}};
(18,  0)*{\cdots};
(24,  0)*{\affr{6}{8}};
(27,  2)*{\aflabelleft{\psi'_n}};
(10, -5)*{\afvjm2};
(10,-10)*{\affr68};
(10,-10)*{\copy\contrdown};
(24, -5)*{\afvjm2};
(24,-10)*{\affr68};
(24,-10)*{\copy\contrdown};
(24,-15)*{\afvj2};
%-
(-16,-12)*{\afvjum{16}{\boldsymbol\iota}{}};
(  4,-18)*{\afaiuex{}{}{}{}{}{}{12}{4}};
(  7,-20)*{\afaiuex{}{}{}{}{}{}{34}{4}};
%----
(-7,  0)*{\affr{22}{30}};
( 4, 13)*{\aflabelleft{\phi}};
(11,  0)*{\affr{10}{30}};
(16, 13)*{\aflabelleft{\psi_1}};
(25,  0)*{\affr{10}{30}};
(30, 13)*{\aflabelleft{\psi_n}};
}\quad.
\]
We then define $\MISR_n(\Phi,a_1,\dots,a_n)$ to be such that $\Psi\to_\frmis\MISR(\Phi,a_1,\dots,a_n)$, where $\phi$, $\psi_1$, $\dots$, $\psi_n$ are the flows, by the same names, shown in Definition~\vref{definition:MultipleIsolatedSubflowsRemoval}.
\end{definition}
%---------------

%--------------------------------------------------------------------
\begin{proposition}\label{proposition:MultipleIsolatedSubflowRemover}
Given the atoms, formulae and derivations described in Definition~\vref{definition:MultipleIsolatedSubflowsRemoval}, and atoms $a_1$, $\dots$, $a_n$ and a derivation $\Phi$ that is in simple form with respect to $a_1$, $\dots$, $a_n$,
\begin{enumerate}
\item $\MISR_n(\Phi,a_1,\dots,a_n)$ is weakly streamlined with respect to $a_1$, $\dots$, $a_n$;
\item for any atom $b$,
\begin{itemize}
\item if $\Phi$ is weakly streamlined with respect to $b$, then $\MISR_n(\Phi,a_1,\dots,a_n)$ is weakly streamlined with respect to $b$, and
\item if $b$ is not the dual of any of $a_1$, $\dots$, $a_n$ and $\Phi$ is in simple form with respect to $b$, then $\MISR_n(\Phi,a_1,\dots,a_n)$ is in simple form with respect to $b$; and
\end{itemize}
\item the size of\/ $\MISR_n(\Phi,a_1,\dots,a_n)$ depends linearly on $N$, polynomially on the size of\/ $\Phi$, and at most polynomially on $\max\{\size{\Gammasf_1},\dots,\size{\Gammasf_N}\}$.
\end{enumerate}
\end{proposition}

\begin{proof}
If $\Phi$ is weakly streamlined to some atom from $a_1$, $\dots$, $a_n$, the result follows by induction. Assume $\Phi$ is not weakly streamlined to any atom from $a_1$, $\dots$, $a_n$, and let $\phi$, $\psi_1$, $\dots$, $\psi_n$, $\phi'$, $\psi'_1$, $\dots$, $\psi'_n$ and $\psi''$ be the atomic flows given in Definition~\ref{definition:MultipleIsolatedSubflowsRemover}, then
\begin{enumerate}
\item by definition there is no path in $\phi$ from an interaction to a cut vertex whose edges are mapped to from instances of one of $a_1$, $\dots$, $a_n$. By Lemma~\vref{lemma:MultipleIsolatedSubflowsRemovalPaths}, we know that if there is a path from an interaction to a cut vertex in the atomic flow of $\MISR_n(\Phi,a_1,\dots,a_n)$ whose edges are mapped to from instances of one of $a_1$, $\dots$, $a_n$, then there must be a path from an interaction to a cut vertex in $\phi$ whose edges are mapped to from instances of one of $a_1$, $\dots$, $a_n$. Hence, the statement follows by contradiction;
\item
\begin{itemize}
 \item if there is a path from an interaction (resp., cut) vertex in the atomic flow of $\MISR_n(\Phi,a_1,\dots,a_n)$ whose edges are mapped to from $b$, then, by Lemma~\ref{lemma:MultipleIsolatedSubflowsRemovalPaths}, there is a path from an interaction (resp., cut) vertex in $\phi$, so also in $\phi'$, whose edges are mapped to from $b$. Hence, the statement follows by contradiction; and
 \item if there is an interaction (reps., cut) vertex $\nu$ and a cut (resp., interaction) vertex $\hat\nu$ in the atomic flow of $\MISR_n(\Phi,a_1,\dots,a_n)$ such that there is a path from $\nu$ to $\hat\nu$ and a path from $\nu$ to $\bot$ (resp., $\top$), both of whose edges are mapped to from $b$, then, by Lemma~\ref{lemma:MultipleIsolatedSubflowsRemovalPaths}, there is an interaction (reps., cut) vertex $\nu'$ and a cut (resp., interaction) vertex $\hat\nu'$ in $\phi$ such that there is a path from $\nu$ to $\hat\nu$ and a path from $\nu$ to $\bot$ (resp., $\top$), both of whose edges are mapped to from $b$. Furthermore, since we can assume that $b$ is not any of $a_1$, $\dots$, $a_n$ or their duals, $\phi$ restricted to $b$ equals $\phi'$ restricted to $b$. Hence, the statement follows by contradiction.
\end{itemize}
\item the statement follows by Theorem~\vref{theorem:SoundMultipleIsolatedSubflowsRemoval}.
\end{enumerate}
\end{proof}
%----------

%--------------------------------------------------
\begin{remark}\label{remark:FromGammasToThresholds}
Given the atoms, formulae and derivations described in Definition~\ref{definition:MultipleIsolatedSubflowsRemoval}, we can prove by induction on $k$, that, for every $1\le i\le n$ and every $0\le k\le N$, the formula $\gamma_{k,i}$ is
\begin{itemize}
 \item true if at least $k$ of the atoms $a_1$, $\dots$, $a_{i-1}$, $a_{i+1}$, $\dots$, $a_n$ are true; and
 \item false if at least $N-k$ of the atoms $a_1$, $\dots$, $a_{i-1}$, $a_{i+1}$, $\dots$, $a_n$ are false.
\end{itemize}
It follows by contradiction that $N\ge n$. Furthermore, if $N=n$, we know that $\gamma_{k,i}$ is true if and only if at least $k$ of the atoms $a_1$, $\dots$, $a_{i-1}$, $a_{i+1}$, $\dots$, $a_n$ are true. This makes $\gamma_{k,i}$ a \emph{threshold formula}\index{threshold!formulae}, as we will se in the next section.
\end{remark}
%-----------

%=============================
\input{global_reductions/threshold_formulae.tex}